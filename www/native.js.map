{"version":3,"file":"native.js","sourceRoot":"","sources":["../scripts/native.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Copyright 2020 Huawei Technologies Co., Ltd.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *      http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { Ads, asyncExec } from './utils';\r\nimport { NativeAdProps, NativeAdEvents, NativeAdOptions, NativeAdConfiguration, NativeAdLoadOptions, IsLoadedResult, IsLoadingResult } from './interfaces';\r\n\r\nconst nativeViews = new Map<string, Native>()\r\nexport class NativeAlreadyDefinedError extends Error {\r\n  public NativeAlreadyDefinedError() {\r\n    this.name = \"NativeAlreadyDefinedError\"\r\n    this.message = \"Native object with the id specified already defined\"\r\n  }\r\n}\r\n\r\nexport class Native extends Ads {\r\n\r\n  public element: HTMLElement\r\n  public props: NativeAdProps\r\n\r\n  constructor() {\r\n    super(Native.name.toLowerCase())\r\n    this.props = {} as NativeAdProps\r\n  }\r\n\r\n  on(eventName: NativeAdEvents, handler: () => void): void {\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n  private beforeCreateHook(options: NativeAdOptions): void {\r\n    const elementId: string = options.div;\r\n\r\n    if (nativeViews.has(elementId))\r\n      throw new NativeAlreadyDefinedError()\r\n\r\n    this.element = document.getElementById(elementId)\r\n    this.props = this.refreshProps()\r\n    console.log(`Props: ${JSON.stringify(this.props)}`);\r\n\r\n    const mutationObserver = new MutationObserver(this.handleMutation);\r\n    mutationObserver.observe(this.element, { attributes: true })\r\n    nativeViews.set(elementId, this)\r\n\r\n  }\r\n\r\n  async create(options: NativeAdOptions): Promise<Native> {\r\n    if (this.id != null)\r\n      return this\r\n\r\n    this.beforeCreateHook(options);\r\n\r\n    const result = await asyncExec('HMSAds', 'createAd', [this.objectName, options])\r\n    this.id = result.id\r\n    return this\r\n  }\r\n\r\n  private refreshProps(): NativeAdProps {\r\n    const elementRect = this.element.getBoundingClientRect()\r\n    const elementStyle = window.getComputedStyle(this.element, null)\r\n\r\n    this.props.x = elementRect.x;\r\n    this.props.y = elementRect.y;\r\n    this.props.width = elementRect.width;\r\n    this.props.height = elementRect.height;\r\n    this.props.paddingLeft = parseInt(elementStyle.getPropertyValue(\"padding-left\"));\r\n    this.props.paddingTop = parseInt(elementStyle.getPropertyValue(\"padding-top\"));\r\n    this.props.borderLeft = parseInt(elementStyle.getPropertyValue(\"border-left-width\"));\r\n    this.props.borderTop = parseInt(elementStyle.getPropertyValue(\"border-top-width\"));\r\n\r\n    return this.props\r\n  }\r\n\r\n\r\n  private handleMutation() {\r\n    this.setProps(this.refreshProps())\r\n  }\r\n\r\n  // Call this function, from ionic application for scroll events\r\n  scroll(): Promise<void>{\r\n    const nativeRect = this.element.getBoundingClientRect()\r\n\r\n    if (this.props.x === nativeRect.x && this.props.y === nativeRect.y)\r\n      return;\r\n\r\n    return this.setProps(this.refreshProps())\r\n  }\r\n\r\n\r\n  loadAd(params: NativeAdLoadOptions): Promise<void> {\r\n    return this.call('loadAd', params)\r\n  }\r\n  isLoaded(): Promise<IsLoadedResult> {\r\n    return this.call('isLoaded')\r\n  }\r\n  isLoading(): Promise<IsLoadingResult> {\r\n    return this.call('isLoading')\r\n  }\r\n  show(): Promise<void> {\r\n    return this.call('show', this.refreshProps())\r\n  }\r\n  destroy(): Promise<void> {\r\n    nativeViews.delete(this.element.id)\r\n    return this.call('destroy')\r\n  }\r\n  setProps(props?: NativeAdProps): Promise<void> {\r\n    return this.call('setProps', props)\r\n  }\r\n\r\n\r\n\r\n}\r\n\r\n\r\nfunction handleDisplacement(event) {\r\n  for (let [objId, nativeAd] of nativeViews) {\r\n    const nativeRect = nativeAd.element.getBoundingClientRect()\r\n\r\n    if (nativeAd.props.x === nativeRect.x && nativeAd.props.y === nativeRect.y)\r\n      continue\r\n\r\n    nativeAd.props.x = nativeRect.x\r\n    nativeAd.props.y = nativeRect.y\r\n\r\n\r\n    nativeAd.setProps(nativeAd.props)\r\n  }\r\n}\r\n\r\nconst mutationObserver: MutationObserver = new MutationObserver(handleDisplacement)\r\nmutationObserver.observe(document.body, { attributes: true, childList: true, subtree: true })\r\nwindow.addEventListener('scroll', handleDisplacement)\r\n\r\n"]}